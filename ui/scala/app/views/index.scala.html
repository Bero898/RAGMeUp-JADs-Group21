@import views.html.helper._
@import play.api.mvc.RequestHeader
@(config: play.api.Configuration, messages: Seq[String])(implicit request: RequestHeader)

@main() {
<div id="mainContainer" class="container">
  <div class="card" id="queryCard">
    <div class="card-body" style="text-align: center; width: 800px;">
      <h3 class="card-title" style="padding-bottom: 50px;">What are you looking for?</h3>
      <div class="input-group mb-3">
        @helper.form(action = routes.HomeController.search(), 'id -> "searchForm") {
          @CSRF.formField
          <input type="text" id="query" class="form-control" placeholder="Enter your query..." name="query">
          <button class="btn btn-primary" type="submit">Search</button>
        }
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-10 offset-md-1">
    <div id="dialogue">
      @for(message <- messages) {
        <p>@message</p>
      }
    </div>
  </div>
</div>

<div id="quizContainer" class="col-md-10 offset-md-1" style="display: none;">
  @helper.form(action = routes.HomeController.generateQuiz(), 'id -> "quizForm") {
    @CSRF.formField
    <div class="quiz-questions"></div>
  }
</div>

<div id="answerContainer" class="offset-md-1 col-md-10" style="display: none;">
  @helper.form(action = routes.HomeController.checkAnswers(), 'id -> "answerForm") {
    @CSRF.formField
    <div id="userAnswers"></div>
    <button class="btn btn-primary" type="submit">Check Answers</button>
  }
</div>

<div class="offset-md-1 col-md-10 chatinput" id="chatContainer">
  @helper.form(action = routes.HomeController.generateQuiz(), 'id -> "chatForm") {
    @CSRF.formField
    <div class="input-group">
      <input type="text" id="chatQuery" class="form-control" placeholder="Chat with the AI..." name="query">
      <button class="btn btn-primary" type="submit">Send</button>
    </div>
  }
  <div id="loader" style="display: none; background: rgba(0, 0, 0, 0);">
    <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><circle cx="4" cy="12" r="3" fill="#000000"><animate id="svgSpinners3DotsBounce0" attributeName="cy" begin="0;svgSpinners3DotsBounce1.end+0.25s" calcMode="spline" dur="0.6s" keySplines=".33,.66,.66,1;.33,0,.66,.33" values="12;6;12"/></circle><circle cx="12" cy="12" r="3" fill="#000000"><animate attributeName="cy" begin="svgSpinners3DotsBounce0.begin+0.1s" calcMode="spline" dur="0.6s" keySplines=".33,.66,.66,1;.33,0,.66,.33" values="12;6;12"/></circle><circle cx="20" cy="12" r="3" fill="#000000"><animate id="svgSpinners3DotsBounce1" attributeName="cy" begin="svgSpinners3DotsBounce0.begin+0.2s" calcMode="spline" dur="0.6s" keySplines=".33,.66,.66,1;.33,0,.66,.33" values="12;6;12"/></circle></svg>
  </div>
</div>

<script type="text/javascript">
$(document).ready(function() {
  var chathistory = [];
  var documents = [];
  var sessionid = uuidv4();

  $.ajaxSetup({
    beforeSend: function(xhr) {
      xhr.setRequestHeader('Csrf-Token', '@helper.CSRF.getToken.value');
    }
  });

  function uuidv4() {
    return "10000000-1000-4000-8000-100000000000".replace(/[018]/g, c =>
      (+c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> +c / 4).toString(16)
    );
  }

  $('#searchForm, #chatForm, #quizForm').on('submit', function(e) {
    e.preventDefault();
    var $form = $(this);
    var formData = {
      query: $form.find('input[name="query"]').val(),
      csrfToken: $form.find('input[name="csrfToken"]').val(),
      history: chathistory,
      docs: documents
    };

    handleSubmit($form, formData);
  });

function handleSubmit($form, formData) {
  $('#loader').show();
  addMessage(formData.query, true);

  $.ajax({
    url: $form.attr('action'), // This should be `/chat` if mapped correctly
    type: 'POST',
    contentType: 'application/json',
    data: JSON.stringify(formData),
    success: function(response) {
      $('#loader').hide();
      
      if (response.rewritten) {
        addMessage('<span style="color: #ccc; font-style: italic;">Rewritten: ' + response.question + '</span>', true);
      }

      if (response.reply) {
        addMessage(response.reply, false);
      }

      if (response.documents) {
        documents = response.documents;
        if (documents.length > 0 && response.fetched_new_documents) {
          presentDocuments(documents);
        }
      }

      if (response.questions) {
        showQuiz(response.questions);
      }

      if (response.feedback) {
        showFeedback(response.feedback);
      }

      chathistory = response.history || chathistory;
      $form.find('input[name="query"]').val('');
    },
    error: function(xhr, status, error) {
      $('#loader').hide();
      addMessage('Error: ' + error, false);
    }
  });
}
  // Keep existing functions
  function addMessage(message, isHuman) { /* ... */ }
  function presentDocuments(documents) { /* ... */ }
  function showQuiz(questions) { /* ... */ }
  function showFeedback(feedback) { /* ... */ }
  
  // Document click handler
  $(document).on('click', '.documentcontainerclass', function() { /* ... */ });

  // Enter key handler
  $('#chatQuery').on('keydown', function(event) {
    if (event.key === 'Enter') {
      event.preventDefault();
      $('#chatForm').submit();
    }
  });
});
</script>
}